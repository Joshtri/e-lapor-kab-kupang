generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ReportCategory {
  id        String   @id @default(dbgenerated("concat('rct_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  name      String   @db.VarChar(255)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi
  subcategories ReportSubcategory[]
  reports       Report[] // Laporan yang menggunakan kategori ini
}

model ReportSubcategory {
  id         String   @id @default(dbgenerated("concat('rsc_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  categoryId String   @db.VarChar(50)
  name       String   @db.VarChar(255)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relasi
  category ReportCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  reports  Report[] // Laporan yang menggunakan subkategori ini
}

model User {
  id            String   @id @default(dbgenerated("concat('usr_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  name          String   @db.VarChar(100)
  nikNumber     String?  @unique
  contactNumber String?  @db.VarChar(15)
  email         String   @unique @db.VarChar(100)
  password      String   @db.VarChar(255)
  role          Role     @default(PELAPOR)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  avatarImage Bytes? // URL ke avatar pengguna, opsional

  // Relasi
  comments      Comment[]
  logs          Log[]
  reports       Report[]
  bugReports    BugReport[]
  notifications Notification[]

  resetPasswordToken   String?   @db.Text
  resetPasswordExpires DateTime?

  // ✅ OPD yang terkait jika role = OPD
  opdId String? @db.VarChar(50) // Null jika bukan OPD staff
  opd   OPD?    @relation("UserToOPD", fields: [opdId], references: [id])

  sentEmails        Email[]            @relation("SentEmails")
  receivedEmails    Email[]            @relation("ReceivedEmails")
  BugComment        BugComment[]
  ChatRoom          ChatRoom[]
  ChatMessage       ChatMessage[]
  pushSubscriptions PushSubscription[]
}

model OPD {
  id      String  @id @default(dbgenerated("concat('opd_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  name    String  @db.VarChar(255) // nama instansi, misalnya "Dinas Kesehatan"
  alamat  String? @db.VarChar(255) // opsional: alamat instansi
  email   String? @unique @db.VarChar(100) // email resmi instansi
  telp    String? @db.VarChar(20) // telepon kantor, bukan staff
  website String? @db.VarChar(100) // opsional: website instansi

  staff         User[]         @relation("UserToOPD") // Multiple staff users can belong to one OPD
  reports       Report[]
  notifications Notification[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  ChatRoom      ChatRoom[]
}

model Report {
  id     String  @id @default(dbgenerated("concat('rep_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  userId String  @db.VarChar(50)
  opdId  String? @db.VarChar(50) // mengacu ke userId OPD

  title       String @db.VarChar(255)
  description String
  location    String @default("empty")

  // ✅ NEW: Relasi ke kategori database
  categoryId    String? @db.VarChar(50) // FK ke ReportCategory
  subcategoryId String? @db.VarChar(50) // FK ke ReportSubcategory

  // Legacy fields (untuk backward compatibility dengan data lama)
  category    String? @db.VarChar(255)
  subcategory String? @db.VarChar(255)

  priority     Priority
  bupatiStatus Status   @default(PENDING)
  opdStatus    Status?  @default(PENDING)
  bupatiReason String? // Alasan Bupati menolak/memproses laporan
  opdReason    String? // Alasan OPD menolak/memproses laporan

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  assignedAt     DateTime? // waktu laporan ditugaskan ke OPD
  respondedAt    DateTime? // waktu OPD mulai merespon laporan
  isReadByBupati Boolean   @default(false)
  isReadByOpd    Boolean   @default(false)

  // Relasi
  comments Comment[]
  logs     Log[]
  user     User      @relation(fields: [userId], references: [id])
  opd      OPD?      @relation(fields: [opdId], references: [id])

  // ✅ Relasi ke kategori
  reportCategory    ReportCategory?    @relation(fields: [categoryId], references: [id])
  reportSubcategory ReportSubcategory? @relation(fields: [subcategoryId], references: [id])

  // ✅ Tambahkan ini untuk menyimpan file gambar langsung
  image Bytes?
}

model Comment {
  id        String   @id @default(dbgenerated("concat('cmt_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  reportId  String   @db.VarChar(50)
  userId    String   @db.VarChar(50)
  comment   String
  createdAt DateTime @default(now())

  report Report @relation(fields: [reportId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
}

model Log {
  id       String  @id @default(dbgenerated("concat('log_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  reportId String  @db.VarChar(50)
  userId   String  @db.VarChar(50)
  action   Action
  details  String? // Add this field to store specific details about the action

  timestamp DateTime @default(now())

  report Report @relation(fields: [reportId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
}

model BugReport {
  id              String      @id @default(dbgenerated("concat('bug_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  userId          String      @db.VarChar(50)
  title           String      @db.VarChar(255)
  description     String
  priorityProblem BugPriority @default(LOW)
  statusProblem   BugStatus   @default(OPEN)
  attachment      Bytes? // Added attachment field for images and other files
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user        User         @relation(fields: [userId], references: [id])
  bugComments BugComment[] // Add this relation
}

//testdulu
model BugComment {
  id          String   @id @default(dbgenerated("concat('bgc_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  bugReportId String   @db.VarChar(50)
  userId      String   @db.VarChar(50)
  message     String   @db.Text
  createdAt   DateTime @default(now())

  bugReport BugReport @relation(fields: [bugReportId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(dbgenerated("concat('ntf_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  userId    String?  @db.VarChar(50) // Untuk user biasa, bisa null jika ditujukan ke OPD
  opdId     String?  @db.VarChar(50) // ID OPD (bukan userId)
  message   String   @db.VarChar(255)
  link      String?  @db.VarChar(255)
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
  opd  OPD?  @relation(fields: [opdId], references: [id])
}

model Email {
  id          String   @id @default(dbgenerated("concat('eml_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  senderId    String   @db.VarChar(50) // ID of the admin who sent the email
  recipientId String   @db.VarChar(50) // ID of the PELAPOR who received the email
  subject     String   @db.VarChar(255)
  content     String   @db.Text
  sentAt      DateTime @default(now())

  // Relations
  sender    User @relation("SentEmails", fields: [senderId], references: [id])
  recipient User @relation("ReceivedEmails", fields: [recipientId], references: [id])
}

model ChatRoom {
  id         String   @id @default(dbgenerated("concat('crm_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  userId     String   @db.VarChar(50) // Pelapor
  opdId      String?  @db.VarChar(50) // Jika chat ditujukan ke OPD
  isToBupati Boolean // true jika chat ke Bupati
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relasi
  user     User          @relation(fields: [userId], references: [id])
  opd      OPD?          @relation(fields: [opdId], references: [id])
  messages ChatMessage[]
}

model ChatMessage {
  id        String   @id @default(dbgenerated("concat('cmg_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  roomId    String   @db.VarChar(50)
  senderId  String   @db.VarChar(50)
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relasi
  room   ChatRoom @relation(fields: [roomId], references: [id])
  sender User     @relation(fields: [senderId], references: [id])
}

// ✅ Web Push Subscription
model PushSubscription {
  id        String   @id @default(dbgenerated("concat('vps_', replace(gen_random_uuid()::text, '-', ''))")) @db.VarChar(50)
  userId    String   @db.VarChar(50)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ✅ App Settings - Single record untuk konfigurasi aplikasi

model AppSettings {
  id                 String   @id @default("settings_main") @db.VarChar(50)
  maintenanceMode    Boolean  @default(false) // ON/OFF maintenance mode
  maintenanceMessage String?  @db.Text // Pesan yang ditampilkan saat maintenance mode
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

enum Role {
  BUPATI
  ADMIN
  PELAPOR
  OPD
}

enum Category {
  INFRASTRUKTUR
  PELAYANAN
  SOSIAL
  LAINNYA
  KEAMANAN
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum Status {
  PENDING
  PROSES
  SELESAI
  DITOLAK
}

enum Action {
  CREATED
  UPDATED
  DELETED
  STATUS_CHANGED
}

enum BugStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum BugPriority {
  LOW
  MEDIUM
  HIGH
}
